<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Heat Loss Calculator Test - Full System</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 1400px;
    margin: 20px auto;
    padding: 20px;
    background: #f5f5f5;
  }
  
  h1, h2 {
    color: #333;
  }
  
  .section {
    background: white;
    padding: 20px;
    margin-bottom: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
  }
  
  label {
    display: block;
    margin: 10px 0 5px;
    font-weight: bold;
  }
  
  select, input, button {
    padding: 8px;
    font-size: 14px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  
  select, input {
    width: 100%;
    max-width: 400px;
  }
  
  button {
    background: #4CAF50;
    color: white;
    border: none;
    padding: 10px 20px;
    cursor: pointer;
    margin-top: 10px;
    margin-right: 10px;
  }
  
  button:hover {
    background: #45a049;
  }
  
  button:disabled {
    background: #ccc;
    cursor: not-allowed;
  }
  
  button.secondary {
    background: #2196F3;
  }
  
  button.secondary:hover {
    background: #0b7dda;
  }
  
  button.danger {
    background: #f44336;
  }
  
  button.danger:hover {
    background: #da190b;
  }
  
  .results {
    margin-top: 20px;
  }
  
  .result-box {
    background: #e8f5e9;
    padding: 15px;
    margin: 10px 0;
    border-left: 4px solid #4CAF50;
  }
  
  .result-box.info {
    background: #e3f2fd;
    border-left-color: #2196F3;
  }
  
  .result-box.warning {
    background: #fff3e0;
    border-left-color: #ff9800;
  }
  
  .result-box h3 {
    margin-top: 0;
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }
  
  th, td {
    text-align: left;
    padding: 8px;
    border-bottom: 1px solid #ddd;
  }
  
  th {
    background: #f5f5f5;
    font-weight: bold;
  }
  
  .error {
    background: #ffebee;
    color: #c62828;
    padding: 10px;
    border-radius: 4px;
    border-left: 4px solid #c62828;
    margin: 10px 0;
  }
  
  .success {
    background: #e8f5e9;
    color: #2e7d32;
    padding: 10px;
    border-radius: 4px;
    border-left: 4px solid #4CAF50;
    margin: 10px 0;
  }
  
  .state-viewer {
    background: #f5f5f5;
    padding: 15px;
    border-radius: 4px;
    font-family: monospace;
    font-size: 12px;
    overflow-x: auto;
    white-space: pre-wrap;
    max-height: 400px;
    overflow-y: auto;
  }
  
  .badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
    margin-left: 10px;
  }
  
  .badge.success {
    background: #4CAF50;
    color: white;
  }
  
  .badge.info {
    background: #2196F3;
    color: white;
  }
  
  .price {
    font-size: 24px;
    font-weight: bold;
    color: #4CAF50;
  }
  
  .price.high {
    color: #f44336;
  }
</style>
</head>
<body>

<h1>üè† Heat Loss Calculator - Complete System Test</h1>

<div class="section">
  <h2>1. User Input Flow</h2>
  
  <label for="postcode">Postcode:</label>
  <input type="text" id="postcode" placeholder="SW1A 1AA" value="SW1A 1AA">
  <div id="postcodeValidation"></div>
  
  <label for="propertyType">Property Type:</label>
  <select id="propertyType">
    <option value="">-- Select --</option>
    <option value="victorianTerrace">Victorian Terrace</option>
    <option value="semi1930s">1930s Semi-Detached</option>
    <option value="postwarDetached">Post-War Detached</option>
    <option value="newbuild">New Build</option>
    <option value="flat">Flat/Apartment</option>
  </select>
  
  <button onclick="initializeApp()">Initialize App</button>
  
  <div id="initResults" class="results"></div>
</div>

<div class="section">
  <h2>2. Calculation Results</h2>
  
  <button onclick="runCalculations()">Run All Calculations</button>
  <button class="secondary" onclick="recalculate()">Recalculate</button>
  
  <div id="calculationResults" class="results"></div>
</div>

<div class="section">
  <h2>3. Pricing & System Options</h2>
  
  <div class="grid">
    <div>
      <h3>Heat Pump System</h3>
      <div id="heatPumpPricing"></div>
    </div>
    <div>
      <h3>Gas Boiler System</h3>
      <div id="boilerPricing"></div>
    </div>
  </div>
  
  <label>
    <input type="checkbox" id="includeGrants" checked onchange="toggleGrantsOption()">
    Include BUS Grant (¬£7,500)
  </label>
  
  <div id="pricingComparison" class="results"></div>
</div>

<div class="section">
  <h2>4. State Management</h2>
  
  <button onclick="showCurrentState()">Show Current State</button>
  <button class="secondary" onclick="saveState()">Save to LocalStorage</button>
  <button class="secondary" onclick="loadState()">Load from LocalStorage</button>
  <button class="danger" onclick="clearState()">Clear State</button>
  <button onclick="testUndo()" id="undoBtn" disabled>Undo</button>
  <button onclick="testRedo()" id="redoBtn" disabled>Redo</button>
  
  <div id="stateOutput" class="results"></div>
</div>

<div class="section">
  <h2>5. Modification Testing</h2>
  
  <h3>Test Space Modification</h3>
  <label for="spaceSelect">Select Space:</label>
  <select id="spaceSelect"></select>
  
  <label for="newWidth">New Width (m):</label>
  <input type="number" id="newWidth" step="0.1" value="5.0">
  
  <label for="newDepth">New Depth (m):</label>
  <input type="number" id="newDepth" step="0.1" value="6.0">
  
  <button onclick="modifySpace()">Modify Space</button>
  
  <div id="modificationResults" class="results"></div>
</div>

<div class="section">
  <h2>6. Climate Data Testing</h2>
  
  <label for="testPostcode">Test Different Postcode:</label>
  <input type="text" id="testPostcode" placeholder="EH1 1AA">
  <button onclick="testClimate()">Test Climate Data</button>
  
  <div id="climateResults" class="results"></div>
</div>

<div class="section">
  <h2>7. Export / Import</h2>
  
  <button onclick="exportState()">Export as JSON</button>
  <button class="secondary" onclick="generateShareableURL()">Generate Shareable URL</button>
  
  <div id="exportResults" class="results"></div>
</div>

<script type="module">
// Import all modules
import { PROPERTY_TEMPLATES, getTemplate, calculateFloorArea } from './propertyTemplates.js';
import { Building } from './Building.js';
import { Space } from './Space.js';
import { HeatLossCalculator } from './HeatLossCalculator.js';
import { calculateSystemCost, getCostRange, calculateRunningCosts } from './pricingData.js';
import { 
  getClimateData, 
  validatePostcode, 
  formatPostcode, 
  getRegionFromPostcode,
  estimateAnnualHeatingCost 
} from './climateData.js';
import {
  subscribe,
  setState,
  getState,
  getValue,
  setPostcode,
  setBuilding,
  setHeatLoss,
  setPricing,
  undo,
  redo,
  canUndo,
  canRedo,
  saveToLocalStorage,
  loadFromLocalStorage,
  clearLocalStorage,
  enableAutoSave,
  debugState
} from './state.js';

// Make available globally
window.getTemplate = getTemplate;
window.Building = Building;
window.HeatLossCalculator = HeatLossCalculator;
window.calculateSystemCost = calculateSystemCost;
window.getClimateData = getClimateData;
window.validatePostcode = validatePostcode;
window.formatPostcode = formatPostcode;

// Subscribe to state changes
subscribe((state) => {
  console.log('State changed:', state);
  updateUndoRedoButtons();
});

// Initialize postcode validation
document.getElementById('postcode').addEventListener('input', (e) => {
  const postcode = e.target.value;
  const isValid = validatePostcode(postcode);
  const output = document.getElementById('postcodeValidation');
  
  if (postcode.length > 3) {
    if (isValid) {
      const formatted = formatPostcode(postcode);
      const region = getRegionFromPostcode(formatted);
      output.innerHTML = `<div class="success">‚úì Valid postcode - Region: ${region || 'Unknown'}</div>`;
    } else {
      output.innerHTML = `<div class="error">‚úó Invalid postcode format</div>`;
    }
  } else {
    output.innerHTML = '';
  }
});

window.initializeApp = function() {
  const postcode = document.getElementById('postcode').value;
  const propertyType = document.getElementById('propertyType').value;
  
  if (!postcode || !propertyType) {
    alert('Please enter postcode and select property type');
    return;
  }
  
  if (!validatePostcode(postcode)) {
    alert('Invalid postcode format');
    return;
  }
  
  try {
    // Format postcode
    const formattedPostcode = formatPostcode(postcode);
    
    // Get climate data
    const climateData = getClimateData(formattedPostcode);
    
    // Get property template
    const template = getTemplate(propertyType);
    
    // Create building
    const building = new Building(template);
    
    // Update state
    setPostcode(formattedPostcode, climateData);
    setState({ propertyType: propertyType });
    setBuilding(building);
    
    // Display results
    let html = '<div class="result-box">';
    html += '<h3>‚úì App Initialized</h3>';
    html += `<p><strong>Postcode:</strong> ${formattedPostcode}</p>`;
    html += `<p><strong>Region:</strong> ${climateData.name}</p>`;
    html += `<p><strong>External Design Temp:</strong> ${climateData.externalDesignTemp}¬∞C</p>`;
    html += `<p><strong>Property:</strong> ${template.name}</p>`;
    html += `<p><strong>Floor Area:</strong> ${building.getTotalFloorArea().toFixed(1)} m¬≤</p>`;
    html += `<p><strong>Spaces:</strong> ${building.getAllSpaces().length}</p>`;
    html += '</div>';
    
    document.getElementById('initResults').innerHTML = html;
    
    // Populate space selector
    populateSpaceSelector();
    
  } catch (error) {
    document.getElementById('initResults').innerHTML = `<div class="error">Error: ${error.message}</div>`;
  }
};

window.runCalculations = function() {
  const state = getState();
  
  if (!state.building) {
    alert('Please initialize app first');
    return;
  }
  
  try {
    // Create calculator with climate data
    const calculator = new HeatLossCalculator(state.climateData);
    
    // Calculate heat loss
    const breakdown = calculator.calculate(state.building);
    
    // Update state
    setHeatLoss(state.building.totalHeatLoss, breakdown);
    
    // Calculate pricing
    const heatPumpCost = calculateSystemCost(state.building, 'heatPump', true);
    const boilerCost = calculateSystemCost(state.building, 'boiler', false);
    
    setPricing(heatPumpCost, boilerCost);
    
    // Display results
    displayCalculationResults();
    displayPricingResults();
    
  } catch (error) {
    document.getElementById('calculationResults').innerHTML = `<div class="error">Error: ${error.message}</div>`;
  }
};

window.recalculate = function() {
  runCalculations();
};

function displayCalculationResults() {
  const state = getState();
  const breakdown = state.heatLoss.breakdown;
  
  let html = '<div class="result-box">';
  html += '<h3>Heat Loss Results</h3>';
  html += `<p><strong>Total Heat Loss:</strong> <span class="price">${state.heatLoss.total.toFixed(2)} kW</span></p>`;
  html += `<p><strong>Fabric Loss:</strong> ${(breakdown.totals.fabricLoss / 1000).toFixed(2)} kW</p>`;
  html += `<p><strong>Ventilation Loss:</strong> ${(breakdown.totals.ventilationLoss / 1000).toFixed(2)} kW</p>`;
  html += `<p><strong>Peak Load:</strong> ${(breakdown.peakLoad / 1000).toFixed(2)} kW</p>`;
  html += '</div>';
  
  // Space breakdown
  html += '<div class="result-box info">';
  html += '<h3>Space-by-Space Breakdown</h3>';
  html += '<table><tr><th>Space</th><th>Floor</th><th>Ceiling</th><th>Walls</th><th>Windows</th><th>Vent</th><th>Total</th></tr>';
  
  state.building.getAllSpaces().forEach(space => {
    const spaceLoss = breakdown.spaces[space.id];
    const wallLoss = Object.values(spaceLoss.walls).reduce((sum, val) => sum + val, 0);
    
    html += `
      <tr>
        <td>${space.name}</td>
        <td>${(spaceLoss.floor).toFixed(0)} W</td>
        <td>${(spaceLoss.ceiling).toFixed(0)} W</td>
        <td>${(wallLoss).toFixed(0)} W</td>
        <td>${(spaceLoss.windows).toFixed(0)} W</td>
        <td>${(spaceLoss.ventilation).toFixed(0)} W</td>
        <td><strong>${(spaceLoss.total).toFixed(0)} W</strong></td>
      </tr>
    `;
  });
  
  html += '</table></div>';
  
  document.getElementById('calculationResults').innerHTML = html;
}

function displayPricingResults() {
  const state = getState();
  
  // Heat pump
  let hpHtml = '<div class="result-box">';
  hpHtml += `<p><strong>Capacity:</strong> ${state.pricing.heatPump.capacity} kW</p>`;
  hpHtml += `<p><strong>Equipment:</strong> ¬£${state.pricing.heatPump.breakdown.heatPumpUnit.toLocaleString()}</p>`;
  hpHtml += `<p><strong>Radiators:</strong> ¬£${state.pricing.heatPump.breakdown.radiators.toLocaleString()} (${state.pricing.heatPump.radiatorCount}√ó)</p>`;
  hpHtml += `<p><strong>Installation:</strong> ${state.pricing.heatPump.installationDays} days</p>`;
  hpHtml += `<p class="price">Total: ¬£${state.pricing.heatPump.totalCost.toLocaleString()}</p>`;
  hpHtml += `<p style="color: #4CAF50; font-weight: bold;">After Grant: ¬£${state.pricing.heatPump.finalCost.toLocaleString()}</p>`;
  hpHtml += '</div>';
  document.getElementById('heatPumpPricing').innerHTML = hpHtml;
  
  // Boiler
  let boilerHtml = '<div class="result-box">';
  boilerHtml += `<p><strong>Capacity:</strong> ${state.pricing.boiler.capacity} kW</p>`;
  boilerHtml += `<p><strong>Equipment:</strong> ¬£${state.pricing.boiler.breakdown.boilerUnit.toLocaleString()}</p>`;
  boilerHtml += `<p><strong>Radiators:</strong> ¬£${state.pricing.boiler.breakdown.radiators.toLocaleString()} (${state.pricing.boiler.radiatorCount}√ó)</p>`;
  boilerHtml += `<p><strong>Installation:</strong> ${state.pricing.boiler.installationDays} days</p>`;
  boilerHtml += `<p class="price high">Total: ¬£${state.pricing.boiler.totalCost.toLocaleString()}</p>`;
  boilerHtml += '</div>';
  document.getElementById('boilerPricing').innerHTML = boilerHtml;
  
  // Comparison
  const savings = state.pricing.heatPump.finalCost - state.pricing.boiler.totalCost;
  let compHtml = '<div class="result-box warning">';
  compHtml += '<h3>Cost Comparison</h3>';
  if (savings < 0) {
    compHtml += `<p><strong>Heat Pump is ¬£${Math.abs(savings).toLocaleString()} cheaper</strong> (with grant)</p>`;
  } else {
    compHtml += `<p><strong>Boiler is ¬£${savings.toLocaleString()} cheaper</strong> upfront</p>`;
  }
  
  // Running costs
  const hpRunning = calculateRunningCosts(state.building, 'heatPump');
  const boilerRunning = calculateRunningCosts(state.building, 'boiler');
  compHtml += `<p>Heat Pump annual running: ¬£${hpRunning.annualCost.toLocaleString()}</p>`;
  compHtml += `<p>Boiler annual running: ¬£${boilerRunning.annualCost.toLocaleString()}</p>`;
  compHtml += '</div>';
  
  document.getElementById('pricingComparison').innerHTML = compHtml;
}

window.toggleGrantsOption = function() {
  setState({
    pricing: {
      includeGrants: document.getElementById('includeGrants').checked
    }
  });
  
  if (getValue('heatLoss.calculated')) {
    runCalculations();
  }
};

window.showCurrentState = function() {
  const state = getState();
  const json = JSON.stringify(state, null, 2);
  
  let html = '<div class="result-box info">';
  html += '<h3>Current Application State</h3>';
  html += `<div class="state-viewer">${json}</div>`;
  html += '</div>';
  
  document.getElementById('stateOutput').innerHTML = html;
};

window.saveState = function() {
  const success = saveToLocalStorage();
  if (success) {
    document.getElementById('stateOutput').innerHTML = '<div class="success">‚úì State saved to localStorage</div>';
  }
};

window.loadState = function() {
  const success = loadFromLocalStorage();
  if (success) {
    document.getElementById('stateOutput').innerHTML = '<div class="success">‚úì State loaded from localStorage</div>';
    
    // Refresh displays
    const state = getState();
    if (state.building) {
      document.getElementById('postcode').value = state.postcode || '';
      populateSpaceSelector();
      
      if (state.heatLoss.calculated) {
        displayCalculationResults();
        displayPricingResults();
      }
    }
  } else {
    document.getElementById('stateOutput').innerHTML = '<div class="error">No saved state found</div>';
  }
};

window.clearState = function() {
  if (confirm('Clear all saved data?')) {
    clearLocalStorage();
    document.getElementById('stateOutput').innerHTML = '<div class="success">‚úì State cleared</div>';
  }
};

window.testUndo = function() {
  if (undo()) {
    document.getElementById('stateOutput').innerHTML = '<div class="success">‚úì Undo successful</div>';
    if (getValue('heatLoss.calculated')) {
      runCalculations();
    }
  }
};

window.testRedo = function() {
  if (redo()) {
    document.getElementById('stateOutput').innerHTML = '<div class="success">‚úì Redo successful</div>';
    if (getValue('heatLoss.calculated')) {
      runCalculations();
    }
  }
};

function updateUndoRedoButtons() {
  document.getElementById('undoBtn').disabled = !canUndo();
  document.getElementById('redoBtn').disabled = !canRedo();
}

function populateSpaceSelector() {
  const state = getState();
  if (!state.building) return;
  
  const select = document.getElementById('spaceSelect');
  select.innerHTML = '<option value="">-- Select Space --</option>';
  
  state.building.getAllSpaces().forEach(space => {
    const option = document.createElement('option');
    option.value = space.id;
    option.textContent = `${space.name} (${space.width}m √ó ${space.depth}m)`;
    select.appendChild(option);
  });
}

window.modifySpace = function() {
  const state = getState();
  if (!state.building) {
    alert('Please initialize app first');
    return;
  }
  
  const spaceId = document.getElementById('spaceSelect').value;
  const newWidth = parseFloat(document.getElementById('newWidth').value);
  const newDepth = parseFloat(document.getElementById('newDepth').value);
  
  if (!spaceId) {
    alert('Please select a space');
    return;
  }
  
  try {
    // Update building
    state.building.updateSpaceDimensions(spaceId, newWidth, newDepth);
    
    // Update state (triggers history)
    setBuilding(state.building);
    
    // Recalculate
    runCalculations();
    
    // Update selector
    populateSpaceSelector();
    
    document.getElementById('modificationResults').innerHTML = 
      `<div class="success">‚úì Space modified to ${newWidth}m √ó ${newDepth}m. Calculations updated.</div>`;
    
  } catch (error) {
    document.getElementById('modificationResults').innerHTML = 
      `<div class="error">Error: ${error.message}</div>`;
  }
};

window.testClimate = function() {
  const postcode = document.getElementById('testPostcode').value;
  
  if (!validatePostcode(postcode)) {
    alert('Invalid postcode');
    return;
  }
  
  const formatted = formatPostcode(postcode);
  const climate = getClimateData(formatted);
  
  let html = '<div class="result-box info">';
  html += `<h3>Climate Data for ${formatted}</h3>`;
  html += `<p><strong>Region:</strong> ${climate.name}</p>`;
  html += `<p><strong>External Design Temp:</strong> ${climate.externalDesignTemp}¬∞C</p>`;
  html += `<p><strong>Heating Degree Days:</strong> ${climate.heatingDegreeDays}</p>`;
  html += `<p><strong>Wind Exposure:</strong> ${climate.windExposure}</p>`;
  html += `<p><strong>Altitude:</strong> ${climate.altitude}m</p>`;
  
  // Estimate heating cost for this region
  const state = getState();
  if (state.building) {
    const cost = estimateAnnualHeatingCost(state.building.totalHeatLoss, climate.regionKey, 'gas');
    html += `<hr><p><strong>Estimated Annual Heating (Gas):</strong> ¬£${cost.annualCost.toLocaleString()}</p>`;
    html += `<p><strong>Monthly Average:</strong> ¬£${cost.monthlyAverage.toLocaleString()}</p>`;
  }
  
  html += '</div>';
  
  document.getElementById('climateResults').innerHTML = html;
};

window.exportState = function() {
  const state = getState();
  const json = JSON.stringify(state, null, 2);
  
  // Create download link
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  
  let html = '<div class="result-box">';
  html += '<h3>Export Data</h3>';
  html += `<a href="${url}" download="heating-assessment.json">Download JSON File</a>`;
  html += '<hr>';
  html += `<div class="state-viewer">${json}</div>`;
  html += '</div>';
  
  document.getElementById('exportResults').innerHTML = html;
};

window.generateShareableURL = function() {
  const state = getState();
  if (!state.building) {
    alert('Please initialize app first');
    return;
  }
  
  const data = {
    p: state.postcode,
    t: state.propertyType,
    b: state.building.toJSON()
  };
  
  const encoded = btoa(JSON.stringify(data));
  const url = `${window.location.origin}${window.location.pathname}?data=${encoded}`;
  
  let html = '<div class="result-box info">';
  html += '<h3>Shareable URL Generated</h3>';
  html += `<p style="word-break: break-all;"><a href="${url}" target="_blank">${url}</a></p>`;
  html += '<button onclick="copyURL(this.previousElementSibling.textContent)">Copy URL</button>';
  html += '<p style="margin-top: 10px; font-size: 12px;">Share this link to let others view your assessment</p>';
  html += '</div>';
  
  document.getElementById('exportResults').innerHTML = html;
};

window.copyURL = function(url) {
  navigator.clipboard.writeText(url).then(() => {
    alert('URL copied to clipboard!');
  });
};

// Enable auto-save
enableAutoSave(30000);

// Initial message
console.log('Heat Loss Calculator Test Page Loaded');
console.log('State management active. Type window.__debugState() to view state.');

</script>

</body>
</html>
