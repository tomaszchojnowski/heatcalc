<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Heat Loss Calculator Test - Simple</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 1200px;
    margin: 20px auto;
    padding: 20px;
    background: #f5f5f5;
  }

h1, h2 {
color: #333;
}

.section {
background: white;
padding: 20px;
margin-bottom: 20px;
border-radius: 8px;
box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
gap: 20px;
}

label {
display: block;
margin: 10px 0 5px;
font-weight: bold;
}

select, input, button {
padding: 8px;
font-size: 14px;
border: 1px solid #ccc;
border-radius: 4px;
}

select, input {
width: 100%;
max-width: 400px;
}

button {
background: #4CAF50;
color: white;
border: none;
padding: 10px 20px;
cursor: pointer;
margin-top: 10px;
margin-right: 10px;
}

button:hover {
background: #45a049;
}

button.secondary {
background: #2196F3;
}

button.secondary:hover {
background: #0b7dda;
}

.results {
margin-top: 20px;
}

.result-box {
background: #e8f5e9;
padding: 15px;
margin: 10px 0;
border-left: 4px solid #4CAF50;
}

.result-box.info {
background: #e3f2fd;
border-left-color: #2196F3;
}

.result-box h3 {
margin-top: 0;
}

table {
width: 100%;
border-collapse: collapse;
margin-top: 10px;
}

th, td {
text-align: left;
padding: 8px;
border-bottom: 1px solid #ddd;
}

th {
background: #f5f5f5;
font-weight: bold;
}

.error {
background: #ffebee;
color: #c62828;
padding: 10px;
border-radius: 4px;
border-left: 4px solid #c62828;
}

.success {
background: #e8f5e9;
color: #2e7d32;
padding: 10px;
border-radius: 4px;
border-left: 4px solid #4CAF50;
}

.price {
font-size: 24px;
font-weight: bold;
color: #4CAF50;
}
</style>

</head>
<body>

<h1>üè† Heat Loss Calculator - Simple Test</h1>

<div class="section">
  <h2>1. Select Property & Location</h2>

<label for="postcode">Postcode:</label>
<input type="text" id="postcode" placeholder="SW1A 1AA" value="SW1A 1AA">

<label for="propertyType">Property Type:</label>
<select id="propertyType">
<option value="">‚Äì Select ‚Äì</option>
<option value="victorian_terrace">Victorian Terrace</option>
<option value="semi_1930s">1930s Semi-Detached</option>
<option value="postwar_detached">Post-War Detached</option>
<option value="newbuild">New Build</option>
<option value="flat">Flat/Apartment</option>
</select>

<button onclick="loadAndCalculate()">Load Property & Calculate</button>

  <div id="propertyInfo" class="results"></div>
</div>

<div class="section">
  <h2>2. Heat Loss Results</h2>
  <div id="heatLossResults" class="results"></div>
</div>

<div class="section">
  <h2>3. System Costs</h2>
  <div class="grid">
    <div id="heatPumpCost"></div>
    <div id="boilerCost"></div>
  </div>
</div>

<div class="section">
  <h2>4. Climate Data</h2>
  <div id="climateInfo" class="results"></div>
</div>

<script type="module">
// Import modules
import { getTemplate, calculateFloorArea } from './propertyTemplates.js';
import { Building } from './Building.js';
import { HeatLossCalculator } from './HeatLossCalculator.js';
import { calculateSystemCost, calculateRunningCosts } from './pricingData.js';
import { getClimateData, validatePostcode, formatPostcode } from './climateData.js';

// Global variables (simple approach)
let currentBuilding = null;
let currentClimate = null;

window.loadAndCalculate = function() {
  const postcode = document.getElementById('postcode').value;
  const propertyType = document.getElementById('propertyType').value;
  
  console.log('Starting calculation...', { postcode, propertyType });
  
  if (!postcode || !propertyType) {
    alert('Please enter postcode and select property type');
    return;
  }
  
  if (!validatePostcode(postcode)) {
    alert('Invalid postcode format');
    return;
  }
  
  try {
    // 1. Format postcode and get climate
    console.log('Getting climate data...');
    const formattedPostcode = formatPostcode(postcode);
    currentClimate = getClimateData(formattedPostcode);
    console.log('Climate data:', currentClimate);
    
    // Display climate info
    let climateHtml = '<div class="result-box info">';
    climateHtml += `<h3>Climate Data for ${formattedPostcode}</h3>`;
    climateHtml += `<p><strong>Region:</strong> ${currentClimate.name}</p>`;
    climateHtml += `<p><strong>External Design Temp:</strong> ${currentClimate.externalDesignTemp}¬∞C</p>`;
    climateHtml += `<p><strong>Heating Degree Days:</strong> ${currentClimate.heatingDegreeDays}</p>`;
    climateHtml += '</div>';
    document.getElementById('climateInfo').innerHTML = climateHtml;
    
    // 2. Load template and create building
    console.log('Loading template...');
    const template = getTemplate(propertyType);
    console.log('Template:', template);
    
    console.log('Creating building...');
    currentBuilding = new Building(template);
    console.log('Building created:', currentBuilding);
    
    const floorArea = currentBuilding.getTotalFloorArea();
    console.log('Floor area:', floorArea);
    
    let propHtml = '<div class="result-box">';
    propHtml += `<h3>Property: ${template.name}</h3>`;
    propHtml += `<p><strong>Era:</strong> ${template.era}</p>`;
    propHtml += `<p><strong>Bedrooms:</strong> ${template.commonBedrooms}</p>`;
    propHtml += `<p><strong>Dimensions:</strong> ${template.dimensions.width}m √ó ${template.dimensions.depth}m</p>`;
    propHtml += `<p><strong>Floors:</strong> ${template.dimensions.floors}</p>`;
    propHtml += `<p><strong>Total Floor Area:</strong> ${floorArea.toFixed(1)} m¬≤</p>`;
    propHtml += `<p><strong>Number of Spaces:</strong> ${currentBuilding.getAllSpaces().length}</p>`;
    propHtml += '</div>';
    document.getElementById('propertyInfo').innerHTML = propHtml;
    
    // 3. Calculate heat loss
    console.log('Calculating heat loss...');
    const calculator = new HeatLossCalculator(currentClimate);
    console.log('Calculator created:', calculator);
    
    const breakdown = calculator.calculate(currentBuilding);
    console.log('Heat loss calculated:', breakdown);
    console.log('Total heat loss:', currentBuilding.totalHeatLoss);
    
    let heatHtml = '<div class="result-box">';
    heatHtml += '<h3>Heat Loss Summary</h3>';
    heatHtml += `<p class="price">${currentBuilding.totalHeatLoss.toFixed(2)} kW</p>`;
    heatHtml += `<p><strong>Fabric Loss:</strong> ${(breakdown.totals.fabricLoss / 1000).toFixed(2)} kW</p>`;
    heatHtml += `<p><strong>Ventilation Loss:</strong> ${(breakdown.totals.ventilationLoss / 1000).toFixed(2)} kW</p>`;
    heatHtml += `<p><strong>Thermal Bridging:</strong> ${(breakdown.totals.thermalBridging / 1000).toFixed(2)} kW</p>`;
    heatHtml += `<p><strong>Peak Load (20% margin):</strong> ${(breakdown.peakLoad / 1000).toFixed(2)} kW</p>`;
    heatHtml += '</div>';
    
    // Space breakdown table
    heatHtml += '<div class="result-box info">';
    heatHtml += '<h3>Space-by-Space Breakdown</h3>';
    heatHtml += '<table>';
    heatHtml += '<tr><th>Space</th><th>Floor Area</th><th>Heat Loss</th><th>W/m¬≤</th></tr>';
    
    currentBuilding.getAllSpaces().forEach(space => {
      const spaceLoss = breakdown.spaces[space.id];
      const lossPerM2 = spaceLoss.total / space.floorArea;
      
      heatHtml += `
        <tr>
          <td>${space.name}</td>
          <td>${space.floorArea.toFixed(1)} m¬≤</td>
          <td>${spaceLoss.total.toFixed(0)} W</td>
          <td>${lossPerM2.toFixed(0)} W/m¬≤</td>
        </tr>
      `;
    });
    
    heatHtml += '</table></div>';
    document.getElementById('heatLossResults').innerHTML = heatHtml;
    
    // 4. Calculate costs
    console.log('Calculating costs...');
    const heatPumpCost = calculateSystemCost(currentBuilding, 'heatPump', true);
    const boilerCost = calculateSystemCost(currentBuilding, 'boiler', false);
    console.log('Heat pump cost:', heatPumpCost);
    console.log('Boiler cost:', boilerCost);
    
    // Heat pump display
    let hpHtml = '<div class="result-box">';
    hpHtml += '<h3>Heat Pump System</h3>';
    hpHtml += `<p><strong>Capacity:</strong> ${heatPumpCost.capacity} kW</p>`;
    hpHtml += `<p><strong>Equipment:</strong> ¬£${heatPumpCost.breakdown.heatPumpUnit.toLocaleString()}</p>`;
    hpHtml += `<p><strong>Radiators (${heatPumpCost.radiatorCount}√ó):</strong> ¬£${heatPumpCost.breakdown.radiators.toLocaleString()}</p>`;
    hpHtml += `<p><strong>Pipework:</strong> ¬£${heatPumpCost.breakdown.pipework.toLocaleString()}</p>`;
    hpHtml += `<p><strong>Hot Water Cylinder:</strong> ¬£${heatPumpCost.breakdown.hotWaterCylinder.toLocaleString()}</p>`;
    hpHtml += `<p><strong>Controls:</strong> ¬£${heatPumpCost.breakdown.controls.toLocaleString()}</p>`;
    hpHtml += `<p><strong>Labor (${heatPumpCost.installationDays} days):</strong> ¬£${heatPumpCost.breakdown.labor.toLocaleString()}</p>`;
    hpHtml += `<hr>`;
    hpHtml += `<p><strong>Total Cost:</strong> ¬£${heatPumpCost.totalCost.toLocaleString()}</p>`;
    hpHtml += `<p><strong>BUS Grant:</strong> -¬£${heatPumpCost.grantAmount.toLocaleString()}</p>`;
    hpHtml += `<p class="price">Your Cost: ¬£${heatPumpCost.finalCost.toLocaleString()}</p>`;
    
    // Running costs
    const hpRunning = calculateRunningCosts(currentBuilding, 'heatPump');
    hpHtml += `<hr><p><strong>Annual Running Cost:</strong> ¬£${hpRunning.annualCost.toLocaleString()}/year</p>`;
    hpHtml += `<p><strong>Monthly:</strong> ¬£${hpRunning.monthlyAverage.toLocaleString()}/month</p>`;
    hpHtml += '</div>';
    document.getElementById('heatPumpCost').innerHTML = hpHtml;
    
    // Boiler display
    let boilerHtml = '<div class="result-box">';
    boilerHtml += '<h3>Gas Boiler System</h3>';
    boilerHtml += `<p><strong>Capacity:</strong> ${boilerCost.capacity} kW</p>`;
    boilerHtml += `<p><strong>Equipment:</strong> ¬£${boilerCost.breakdown.boilerUnit.toLocaleString()}</p>`;
    boilerHtml += `<p><strong>Radiators (${boilerCost.radiatorCount}√ó):</strong> ¬£${boilerCost.breakdown.radiators.toLocaleString()}</p>`;
    boilerHtml += `<p><strong>Pipework:</strong> ¬£${boilerCost.breakdown.pipework.toLocaleString()}</p>`;
    boilerHtml += `<p><strong>Controls:</strong> ¬£${boilerCost.breakdown.controls.toLocaleString()}</p>`;
    boilerHtml += `<p><strong>Labor (${boilerCost.installationDays} days):</strong> ¬£${boilerCost.breakdown.labor.toLocaleString()}</p>`;
    boilerHtml += `<hr>`;
    boilerHtml += `<p class="price">Total Cost: ¬£${boilerCost.totalCost.toLocaleString()}</p>`;
    
    // Running costs
    const boilerRunning = calculateRunningCosts(currentBuilding, 'boiler');
    boilerHtml += `<hr><p><strong>Annual Running Cost:</strong> ¬£${boilerRunning.annualCost.toLocaleString()}/year</p>`;
    boilerHtml += `<p><strong>Monthly:</strong> ¬£${boilerRunning.monthlyAverage.toLocaleString()}/month</p>`;
    boilerHtml += '</div>';
    document.getElementById('boilerCost').innerHTML = boilerHtml;
    
    console.log('All calculations complete!');
    
  } catch (error) {
    console.error('Error:', error);
    document.getElementById('propertyInfo').innerHTML = `<div class="error">Error: ${error.message}<br><br>Stack: ${error.stack}</div>`;
  }
};

console.log('Simple test page loaded. Fill in postcode and property type, then click "Load Property & Calculate"');
</script>

</body>
</html>